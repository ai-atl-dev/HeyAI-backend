# Cloud Build pipeline for HeyAI-backend -> Cloud Run
# Prereqs:
# - Artifact Registry repo exists: $_AR_REPO in $_REGION
# - Secrets exist in Secret Manager: ELEVENLABS_API_KEY, ELEVEN_VOICE_ID
# - APIs enabled: run.googleapis.com, cloudbuild.googleapis.com, artifactregistry.googleapis.com, secretmanager.googleapis.com

substitutions:
  _SERVICE_NAME: "heyai-backend"
  _AR_REPO: "services"
  _REGION: "us-central1"
  _BASE_URL: "https://31c44e68f094.ngrok-free.app"
  _VERTEX_AI_LOCATION: "us-central1"
  _VERTEX_AI_MODEL: "gemini-2.5-flash"
  _NGROK_HOST: "b10362b67682.ngrok-free.app"
  _KOOZIE_AGENT_URI: "https://koozie-agent-service-127756525541.us-central1.run.app"

options:
  substitution_option: ALLOW_LOOSE
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET

images:
  - "$_REGION-docker.pkg.dev/$PROJECT_ID/$_AR_REPO/heyai-backend:latest"

steps:
  - name: "gcr.io/cloud-builders/docker"
    args:
      - build
      - "-f"
      - Dockerfile
      - "-t"
      - "$_REGION-docker.pkg.dev/$PROJECT_ID/$_AR_REPO/heyai-backend:latest"
      - .

  - name: "gcr.io/cloud-builders/docker"
    args:
      - push
      - "$_REGION-docker.pkg.dev/$PROJECT_ID/$_AR_REPO/heyai-backend:latest"

  - name: "gcr.io/cloud-builders/gcloud"
    args:
      - run
      - deploy
      - "$_SERVICE_NAME"
      - "--image"
      - "$_REGION-docker.pkg.dev/$PROJECT_ID/$_AR_REPO/heyai-backend:latest"
      - "--region"
      - "$_REGION"
      - "--platform"
      - "managed"
      - "--allow-unauthenticated"
      - "--port"
      - "8080"
      - "--set-env-vars"
      - "BASE_URL=$_BASE_URL,VERTEX_AI_LOCATION=$_VERTEX_AI_LOCATION,VERTEX_AI_MODEL=$_VERTEX_AI_MODEL,NGROK_HOST=$_NGROK_HOST,KOOZIE_AGENT_URI=$_KOOZIE_AGENT_URI"
      - "--set-secrets"
      - "ELEVENLABS_API_KEY=ELEVENLABS_API_KEY:latest,ELEVEN_VOICE_ID=ELEVEN_VOICE_ID:latest"


